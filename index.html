<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BH Installation Estimate Tool v21</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* BASE THEME (LIGHT) */
        :root {
            --bg-body: #f3f4f6;
            --bg-sheet: #ffffff;
            --text-main: #000000;
            --border-main: #000000;
            --input-focus: #eef2ff;
            
            /* Headers */
            --bg-hdr-grey: #e5e7eb;
            --bg-hdr-green: #d1fae5;
            --bg-hdr-blue: #dbeafe;
            --bg-row-blue: #dbeafe;
            --bg-row-yellow: #fef3c7;
            --bg-total-orange: #fed7aa;
        }

        /* DARK THEME OVERRIDES */
        body.dark {
            --bg-body: #111827; /* Gray 900 */
            --bg-sheet: #1f2937; /* Gray 800 */
            --text-main: #e5e7eb; /* Gray 200 */
            --border-main: #4b5563; /* Gray 600 */
            --input-focus: #374151;
            
            /* Headers (Muted for Dark Mode) */
            --bg-hdr-grey: #374151;
            --bg-hdr-green: #064e3b; /* Dark Green */
            --bg-hdr-blue: #1e3a8a; /* Dark Blue */
            --bg-row-blue: #1e3a8a;
            --bg-row-yellow: #78350f; /* Dark Amber */
            --bg-total-orange: #7c2d12; /* Dark Orange */
        }

        body { font-family: 'Arial', sans-serif; background-color: var(--bg-body); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        
        /* SHEET CONTAINER */
        .sheet-container { 
            border: 2px solid var(--border-main); 
            background: var(--bg-sheet); 
            max-width: 1300px; 
            margin: 0 auto; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            margin-bottom: 2rem; 
        }
        
        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border-right: 1px solid var(--border-main); border-bottom: 1px solid var(--border-main); padding: 4px; font-size: 12px; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        td:last-child, th:last-child { border-right: none; }
        
        /* BORDERS */
        .border-b-black { border-bottom-color: var(--border-main) !important; }
        .border-r-black { border-right-color: var(--border-main) !important; }
        .border-black { border-color: var(--border-main) !important; }
        .border-2 { border-width: 2px; }

        /* INPUTS */
        .cell-input { width: 100%; height: 100%; background: transparent; outline: none; text-align: center; font-family: inherit; font-size: inherit; color: var(--text-main); }
        .cell-input.left { text-align: left; padding-left: 4px; }
        .cell-input:focus { background-color: var(--input-focus); }
        textarea.cell-input { resize: none; overflow: hidden; min-height: 1.2em; display: block; white-space: pre-wrap; line-height: 1.2; padding-top: 2px; color: var(--text-main); }
        
        /* DYNAMIC COLORS */
        .bg-hdr-grey { background-color: var(--bg-hdr-grey); font-weight: bold; }
        .bg-hdr-green { background-color: var(--bg-hdr-green); font-weight: bold; text-align: center; }
        .bg-hdr-blue { background-color: var(--bg-hdr-blue); font-weight: bold; }
        .bg-row-blue { background-color: var(--bg-row-blue); }
        .bg-row-yellow { background-color: var(--bg-row-yellow); }
        .bg-total-orange { background-color: var(--bg-total-orange); }
        
        /* Dark Mode Text Fixes for Colored Rows */
        body.dark .bg-hdr-green, body.dark .bg-hdr-blue, body.dark .bg-row-blue, body.dark .bg-row-yellow, body.dark .bg-total-orange {
            color: #e5e7eb;
        }
        /* Specific inputs in colored rows need white text in dark mode */
        body.dark input, body.dark textarea { color: #fff; }
        body.dark ::placeholder { color: #9ca3af; }

        /* MODALS */
        .admin-modal { background-color: #1a1b26; color: white; }
        .admin-header { font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem; border-bottom: 1px solid #374151; padding-bottom: 4px; display: flex; justify-content: space-between; align-items: center;}
        .admin-row { display: grid; grid-template-columns: 1fr 100px 80px 30px; gap: 8px; align-items: center; background: #24283b; padding: 6px; border-radius: 4px; margin-bottom: 6px; border: 1px solid #374151; }
        .admin-input-text { background: #111827; border: 1px solid #374151; color: white; padding: 4px; border-radius: 4px; width: 100%; }
        .admin-input-num { background: #111827; border: 1px solid #374151; color: white; text-align: right; padding: 4px; border-radius: 4px; width: 100%; }
        .admin-select { background: #111827; border: 1px solid #374151; color: #9ca3af; padding: 4px; border-radius: 4px; font-size: 0.75rem; }
        .admin-btn-del { color: #ef4444; font-weight: bold; cursor: pointer; text-align: center; }
        .admin-btn-add { background: #374151; font-size: 0.8rem; padding: 2px 8px; rounded: 4px; cursor: pointer; }
        
        /* LIBRARY TABLE */
        .lib-table th { background-color: var(--bg-hdr-grey); text-align: left; padding: 8px; border-bottom: 2px solid var(--border-main); border-right: none; color: var(--text-main); }
        .lib-table td { border-bottom: 1px solid var(--border-main); padding: 8px; border-right: none; color: var(--text-main); }
        .lib-row:hover { background-color: var(--input-focus); cursor: pointer; }

        /* TOAST */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* PRINT */
        .pdf-page-break { page-break-before: always; border-top: 2px solid #000; margin-top: 20px; padding-top: 40px; }
        .hidden-on-screen { display: none; }
        .visible-on-pdf { display: block !important; }
        @media print {
            body { background: white; margin: 0; color: black; }
            .no-print { display: none !important; }
            .sheet-container { box-shadow: none; margin: 0; width: 100%; max-width: none; border: none; }
            input, textarea, select { border: none; background: transparent; resize: none; appearance: none; color: black; }
            textarea { height: auto; overflow: visible; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-[1300px] mx-auto flex justify-between items-center mb-4 no-print bg-white dark:bg-gray-800 p-3 rounded shadow transition-colors duration-300">
        <div class="flex items-center gap-4">
            <div>
                <h1 class="text-xl font-bold text-gray-800 dark:text-white">BH Estimate Tool v21</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-2">
                    <span id="db-status" class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span id="db-text">Connecting...</span>
                    <span id="current-file-id" class="hidden text-gray-300"></span>
                </p>
            </div>
        </div>
        <div class="space-x-2 flex items-center">
            <button onclick="toggleTheme()" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white border border-gray-400 dark:border-gray-600 px-3 py-1.5 rounded text-sm font-bold shadow" title="Toggle Light/Dark Mode">
                <span id="theme-icon">üåô</span>
            </button>
            <div class="h-6 w-px bg-gray-300 mx-1"></div>
            <button onclick="newEstimate()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 border border-gray-400 px-4 py-1.5 rounded text-sm font-bold shadow flex items-center gap-2">üìÑ New</button>
            <div class="h-6 w-px bg-gray-300 mx-1"></div>
            <button onclick="openLibrary()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-1.5 rounded text-sm font-bold shadow flex items-center gap-2">üìö Library</button>
            <button onclick="saveEstimate('update')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm font-bold shadow flex items-center gap-2">üíæ Save</button>
            <button onclick="saveEstimate('revision')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-sm font-bold shadow flex items-center gap-2">üìã Rev+</button>
            <div class="h-6 w-px bg-gray-300 mx-1"></div>
            <button onclick="toggleAdmin()" class="bg-gray-800 hover:bg-black text-white px-4 py-1.5 rounded text-sm font-bold shadow">‚öôÔ∏è Admin</button>
            <button onclick="generatePDF()" class="bg-gray-700 hover:bg-gray-900 text-white px-4 py-1.5 rounded text-sm font-bold shadow">Download PDF</button>
        </div>
    </div>

    <div id="ui-container" class="sheet-container transition-colors duration-300">
        <div id="page-1">
            <div class="text-center py-4 border-b-2 border-black">
                <h1 class="text-3xl font-bold">BH Installation & Transport</h1>
            </div>

            <div class="grid grid-cols-[1fr_2fr_1fr_1fr] border-b-2 border-black">
                <div class="p-2 border-r-black bg-hdr-grey text-xs flex items-center font-bold">Estimate ref:</div>
                <div class="p-0 border-r-black"><input type="text" id="quoteRef" class="cell-input left font-bold" placeholder="Ref..."></div>
                <div class="p-2 border-r-black bg-hdr-grey text-xs flex items-center justify-end font-bold">Estimate date:</div>
                <div class="p-0"><input type="date" id="quoteDate" class="cell-input px-2 text-right"></div>
            </div>
            <div class="grid grid-cols-[1fr_2fr_2fr] border-b-2 border-black">
                <div class="p-2 border-r-black bg-hdr-grey text-xs flex items-center font-bold">Project:</div>
                <div class="p-0 border-r-black"><input type="text" id="projName" class="cell-input left font-bold" placeholder="Project Name"></div>
                <div class="flex">
                    <div class="bg-total-orange font-bold text-xs p-2 flex items-center border-r-black flex-grow">Estimate valid to (90 days):</div>
                    <div class="font-bold text-xs p-2 bg-sheet min-w-[120px] text-center flex items-center justify-center" id="validDate"></div>
                </div>
            </div>

            <div class="flex">
                <div class="w-5/12 border-r-2 border-black flex flex-col">
                    <table class="w-full">
                        <colgroup><col style="width: 50%"><col style="width: 15%"><col style="width: 20%"><col style="width: 15%"></colgroup>
                        <thead><tr class="text-xs"><th class="bg-hdr-blue">Items</th><th class="bg-hdr-green">QTY</th><th class="bg-hdr-green">HRS/Piece</th><th class="bg-hdr-green">Total</th></tr></thead>
                        <tbody id="custom-rows-container"></tbody>
                    </table>
                    <div class="no-print p-1 border-b-black text-center bg-gray-50 dark:bg-gray-700">
                        <button onclick="addItemRow()" class="text-[10px] bg-blue-600 text-white px-4 py-1 rounded font-bold hover:bg-blue-700">+ Add Item Row</button>
                    </div>
                    <table class="w-full border-b-2 border-black">
                        <colgroup><col style="width: 50%"><col style="width: 15%"><col style="width: 20%"><col style="width: 15%"></colgroup>
                        <tbody id="fixed-tasks-container" class="text-xs"></tbody>
                    </table>
                    <div class="grid grid-cols-[1fr_60px] border-b-black">
                        <div class="p-2 border-r-black text-right font-bold bg-hdr-grey text-sm flex items-center justify-end">Total Hours</div>
                        <div class="p-2 text-center font-bold text-lg flex items-center justify-center" id="grandTotalHrs">0.0</div>
                    </div>
                    <div class="grid grid-cols-[1fr_60px] border-b-2 border-black">
                        <div class="p-2 border-r-black text-right text-xs bg-hdr-grey flex items-center justify-end">Labour in Days (<span id="lbl_dayHrs">7.25</span>hr)</div>
                        <div class="p-2 text-center font-bold text-lg flex items-center justify-center" id="grandTotalDays">0.00</div>
                    </div>
                    
                    <div class="bg-row-blue border-b-2 border-black p-2 flex items-center justify-between">
                        <span class="font-bold text-sm">Manual Days on Site:</span>
                        <input type="number" id="manualGlobalDays" value="1" class="w-20 p-1 text-center border border-black font-bold bg-sheet" oninput="calc()">
                    </div>
                    
                    <div class="flex-grow flex flex-col min-h-[100px] bg-row-blue">
                        <div class="p-1 text-xs font-bold border-b border-gray-400 ml-2 opacity-70">Site Notes</div>
                        <textarea id="siteNotes" class="w-full flex-grow bg-transparent p-2 resize-none text-sm placeholder-gray-500 dark:placeholder-gray-300" placeholder="Enter notes here..."></textarea>
                    </div>
                </div>

                <div class="w-7/12 flex flex-col">
                    <div class="flex h-32 border-b-2 border-black">
                        <div class="w-1/2 border-r-2 border-black bg-row-blue flex flex-col">
                            <div class="text-xs text-center p-1 border-b-black">Collection Address</div>
                            <div class="flex-grow flex items-center justify-center p-2 text-center text-sm font-bold"><textarea id="colAddr" class="w-full h-full bg-transparent text-center resize-none">RSF Ropley&#10;SO24 0EF</textarea></div>
                        </div>
                        <div class="w-1/2 bg-row-blue flex flex-col">
                            <div class="text-xs text-center p-1 border-b-black">Site / Delivery Address</div>
                            <div class="flex-grow p-2"><textarea id="siteAddr" class="w-full h-full bg-transparent text-center resize-none placeholder-gray-500 dark:placeholder-gray-300 font-bold" placeholder="Enter Site Address..."></textarea></div>
                        </div>
                    </div>
                    <div class="bg-row-yellow border-b-2 border-black p-2 h-20"><textarea id="specificNotes" class="w-full h-full bg-transparent resize-none text-xs placeholder-gray-600 dark:placeholder-gray-300" placeholder="Site specific notes..."></textarea></div>
                    
                    <table class="w-full border-b-black">
                        <colgroup><col style="width: 40%"><col style="width: 15%"><col style="width: 15%"><col style="width: 15%"><col style="width: 15%"></colgroup>
                        <thead><tr class="text-xs bg-hdr-grey font-bold"><th>Role</th><th>Installers</th><th>Cost/Day</th><th>Days</th><th>Total</th></tr></thead>
                        <tbody id="labour-rows" class="text-xs"></tbody>
                    </table>
                    <table class="w-full border-b-black">
                        <colgroup><col style="width: 55%"><col style="width: 15%"><col style="width: 15%"><col style="width: 15%"></colgroup>
                        <tbody id="expenses-rows" class="text-xs"></tbody>
                    </table>
                    <table class="w-full border-b-black">
                        <colgroup><col style="width: 25%"><col style="width: 20%"><col style="width: 15%"><col style="width: 20%"><col style="width: 20%"></colgroup>
                        <thead><tr class="text-xs bg-hdr-grey font-bold"><th>Size</th><th>Cost</th><th>Qty</th><th>Area</th><th>Total</th></tr></thead>
                        <tbody id="veh-rows" class="text-xs"></tbody>
                    </table>

                    <div class="flex flex-grow">
                        <div class="w-7/12 border-r-2 border-black flex flex-col text-xs" id="globals-rows"></div>
                        <div class="w-5/12 bg-total-orange flex flex-col justify-end">
                            <div class="flex justify-between items-center p-2 border-b-black"><span class="font-bold text-lg">Estimate Total</span><span class="font-bold text-xl" id="finalTotal">¬£0.00</span></div>
                            <div class="flex justify-between items-center p-2 border-b-black text-xs font-bold opacity-80"><span>OOH Total (x<span id="lbl_ooh">1.6</span>)</span><span id="oohTotal">¬£0.00</span></div>
                            <div class="flex justify-between items-center p-2 border-b-black text-xs font-bold opacity-80"><span>Saturday Total (x<span id="lbl_sat">1.75</span>)</span><span id="satTotal">¬£0.00</span></div>
                            <div class="flex justify-between items-center p-2 text-xs font-bold opacity-80"><span>Sunday Total (x<span id="lbl_sun">2.0</span>)</span><span id="sunTotal">¬£0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t-2 border-black flex">
                <div class="w-8/12 p-2 text-[10px] leading-tight border-r-2 border-black"><strong>Note:</strong> T&Cs are attached on the following page.</div>
                <div class="w-4/12 flex flex-col">
                    <div class="text-[10px] font-bold text-center border-b-black p-1 bg-hdr-grey">Estimate Issued By</div>
                    <div class="flex-grow flex items-center justify-center p-2"><input type="text" value="Ben Hone" class="text-center font-bold text-xl w-full"></div>
                </div>
            </div>
        </div>

        <div id="page-2" class="hidden-on-screen p-12 bg-sheet transition-colors duration-300">
            <h2 class="text-2xl font-bold border-b-2 border-black pb-4 mb-6">Terms & Conditions of Business</h2>
            <div id="terms-display" class="text-sm text-justify whitespace-pre-wrap leading-relaxed"></div>
        </div>
    </div>

    <div id="toast">Saved!</div>

    <div id="library-view" class="hidden fixed inset-0 bg-black bg-opacity-75 overflow-y-auto p-4 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-[1000px] max-h-[85vh] flex flex-col text-gray-800 dark:text-white">
            <div class="flex justify-between items-center mb-4 border-b dark:border-gray-600 pb-2">
                <h3 class="text-2xl font-bold">Estimate Library</h3>
                <button onclick="document.getElementById('library-view').classList.add('hidden')" class="text-gray-500 hover:text-gray-300 text-xl font-bold">‚úï</button>
            </div>
            <div class="mb-4">
                <input type="text" id="lib-search" class="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Search Project Name or Ref..." oninput="filterLibrary()">
            </div>
            <div class="flex-grow overflow-y-auto">
                <table class="w-full lib-table">
                    <thead>
                        <tr>
                            <th style="width: 100px;">Date</th>
                            <th style="width: 150px;">Ref Code</th>
                            <th>Project</th>
                            <th style="width: 100px;">Total</th>
                            <th style="width: 160px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lib-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="admin-view" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 overflow-y-auto p-4 z-50 flex items-center justify-center">
        <div class="admin-modal rounded-lg shadow-2xl p-8 w-[1000px] border border-gray-700 h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                <h2 class="text-2xl font-bold text-white">Admin Configuration (Cloud Synced)</h2>
                <button onclick="toggleAdmin()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">Close</button>
            </div>
            <div class="grid grid-cols-2 gap-8 overflow-y-auto flex-grow pr-2">
                <div>
                    <div class="mb-6"><div class="admin-header text-blue-400"><span>Labour & Operational Rates</span><button class="admin-btn-add text-white" onclick="addNewRow('labour')">+ Add</button></div><div id="adm-labour-list"></div></div>
                    <div class="mb-6"><div class="admin-header text-purple-400"><span>Scope Items (Hrs)</span><button class="admin-btn-add text-white" onclick="addNewRow('tasks')">+ Add</button></div><div id="adm-tasks-list"></div></div>
                </div>
                <div>
                    <div class="mb-6"><div class="admin-header text-green-400"><span>Vehicles</span><button class="admin-btn-add text-white" onclick="addNewRow('vehicles')">+ Add</button></div><div id="adm-vehicles-list"></div></div>
                    <div class="mb-6"><div class="admin-header text-red-400"><span>Expenses / Charges</span><button class="admin-btn-add text-white" onclick="addNewRow('expenses')">+ Add</button></div><div id="adm-expenses-list"></div></div>
                    <div class="mb-6"><div class="admin-header text-orange-400">Globals & Multipliers</div><div id="adm-globals-list"></div></div>
                </div>
                <div class="col-span-2 mt-4 pt-4 border-t border-gray-600">
                    <div class="admin-header text-yellow-400">Terms & Conditions (PDF Page 2)</div>
                    <textarea id="adm-terms-input" class="w-full h-40 bg-[#111827] text-white p-4 rounded border border-gray-600 font-mono text-xs"></textarea>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-600 flex justify-between items-center">
                <button onclick="saveAdmin()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg px-8 py-3 rounded shadow-lg">Save & Apply Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE ---
        const PROJECT_URL = 'https://wgsqrjnliglemogtukly.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indnc3Fyam5saWdsZW1vZ3R1a2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5ODY2MTIsImV4cCI6MjA3OTU2MjYxMn0.chlJ9Ba2kQDu_xnqMfwcRwv5pgiwHnv7FJJSzKxbPeM';
        const supabase = window.supabase.createClient(PROJECT_URL, ANON_KEY);

        const DEFAULT_TERMS = `1. All estimates are supplied on the assumption of clear access...`;
        const DEFAULT_CONFIG = {
            labour: [ { id: 'l1', label: "Installer + Veh", val: 325, type: 'day' }, { id: 'l2', label: "2 Person Team", val: 550, type: 'day' }, { id: 'l3', label: "Installer On Foot", val: 185, type: 'day' }, { id: 'l4', label: "Supervisor", val: 220, type: 'day' }, { id: 'l5', label: "Custom/Snag", val: 750, type: 'day' } ],
            vehicles: [ { id: 'v1', label: "SWB Van", val: 170, type: 'fixed' }, { id: 'v2', label: "XLWB Van", val: 200, type: 'fixed' }, { id: 'v3', label: "Luton Van", val: 230, type: 'fixed' }, { id: 'v4', label: "7.5T Truck", val: 540, type: 'fixed' }, { id: 'v5', label: "18T Truck", val: 720, type: 'fixed' } ],
            tasks: [ { id: 't1', label: "Standard Uplift", val: 0.3, type: 'hrs' }, { id: 't2', label: "Unwrap/Level", val: 0.2, type: 'hrs' }, { id: 't3', label: "Extended Uplift", val: 0.5, type: 'hrs_check' }, { id: 't4', label: "Stairs (per Item)", val: 0.1, type: 'hrs_check' } ],
            expenses: [ { id: 'e1', label: "Additional Miles", val: 0.90, type: 'fixed' }, { id: 'e2', label: "Waste Disposal", val: 340, type: 'fixed' }, { id: 'e3', label: "ULEZ/City Charge", val: 15, type: 'fixed' }, { id: 'e4', label: "Parking Cost", val: 75, type: 'day' } ],
            globals: [ { id: 'g1', label: "Working Day Hours", val: 7.25 }, { id: 'g2', label: "OOH Multiplier", val: 1.6 }, { id: 'g3', label: "Sat Multiplier", val: 1.75 }, { id: 'g4', label: "Sun Multiplier", val: 2.0 } ],
            terms: DEFAULT_TERMS
        };

        let config = DEFAULT_CONFIG;
        let currentEstimateId = null;
        let libraryData = [];

        // --- THEME LOGIC ---
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            document.getElementById('theme-icon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('bh_theme', isDark ? 'dark' : 'light');
        }

        window.onload = async function() {
            // Load Theme Preference
            if (localStorage.getItem('bh_theme') === 'dark') {
                document.body.classList.add('dark');
                document.getElementById('theme-icon').innerText = '‚òÄÔ∏è';
            }

            await loadSharedConfig();
            addItemRow();
            renderMainSheet();
            const d = new Date(); 
            document.getElementById('quoteDate').valueAsDate = d;
            d.setDate(d.getDate() + 90);
            document.getElementById('validDate').innerText = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            calc();
        };

        async function loadSharedConfig() {
            try {
                const { data, error } = await supabase.from('app_settings').select('*').eq('id', 1).single();
                if (data && data.config) {
                    config = data.config;
                    document.getElementById('db-status').className = "w-2 h-2 rounded-full bg-green-500";
                    document.getElementById('db-text').innerText = "Cloud Connected";
                }
            } catch (e) { console.error(e); }
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg; x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- NEW ESTIMATE ---
        function newEstimate() {
            if(!confirm("Clear current estimate?")) return;
            currentEstimateId = null;
            document.getElementById('quoteRef').value = '';
            document.getElementById('projName').value = '';
            document.getElementById('colAddr').value = ""; 
            document.getElementById('siteAddr').value = '';
            document.getElementById('siteNotes').value = '';
            document.getElementById('specificNotes').value = '';
            document.getElementById('manualGlobalDays').value = '1';
            document.getElementById('custom-rows-container').innerHTML = '';
            addItemRow();
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = (i.id === 'manualGlobalDays' ? 1 : ''));
            document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            calc();
            showToast("New Estimate Created");
        }

        async function saveEstimate(mode) {
            const refInput = document.getElementById('quoteRef');
            let ref = refInput.value || "Draft";
            const proj = document.getElementById('projName').value || "Untitled";
            const totalVal = document.getElementById('finalTotal').innerText;

            if (mode === 'revision') {
                const revMatch = ref.match(/-REV(\d+)$/);
                ref = revMatch ? ref.replace(/-REV\d+$/, `-REV${parseInt(revMatch[1]) + 1}`) : `${ref}-REV1`;
                refInput.value = ref;
                document.getElementById('quoteDate').valueAsDate = new Date();
                currentEstimateId = null;
            }

            const estimateData = {
                ref, proj,
                date: document.getElementById('quoteDate').value,
                total: totalVal,
                rows: Array.from(document.querySelectorAll('#custom-rows-container tr')).map(tr => ({
                    desc: tr.querySelector('textarea').value,
                    qty: tr.querySelector('.custom-qty').value,
                    rate: tr.querySelector('.custom-rate').value
                })),
                inputs: {},
                addresses: {
                    col: document.getElementById('colAddr').value,
                    site: document.getElementById('siteAddr').value,
                    notes: document.getElementById('specificNotes').value,
                    siteNotes: document.getElementById('siteNotes').value
                }
            };
            
            document.querySelectorAll('input[type="number"], input[type="text"], input[type="checkbox"]').forEach(el => {
                if(el.id) estimateData.inputs[el.id] = el.type === 'checkbox' ? el.checked : el.value;
            });

            let error;
            if (mode === 'update' && currentEstimateId) {
                const { error: err } = await supabase.from('estimates').update({ ref_code: ref, project_name: proj, data: estimateData }).eq('id', currentEstimateId);
                error = err;
            } else {
                const { data, error: err } = await supabase.from('estimates').insert({ ref_code: ref, project_name: proj, data: estimateData }).select();
                if(data) currentEstimateId = data[0].id;
                error = err;
            }

            if(!error) showToast(mode === 'revision' ? `Created ${ref}!` : "Saved Successfully!");
            else alert("Error: " + error.message);
        }

        async function openLibrary() {
            document.getElementById('library-view').classList.remove('hidden');
            const list = document.getElementById('lib-list');
            list.innerHTML = '<tr><td colspan="5" class="text-center p-4">Loading...</td></tr>';
            const { data, error } = await supabase.from('estimates').select('*').order('created_at', { ascending: false }).limit(50);
            if(data) { libraryData = data; renderLibrary(data); }
        }

        function renderLibrary(data) {
            const list = document.getElementById('lib-list');
            list.innerHTML = '';
            data.forEach(est => {
                const total = est.data.total || '¬£0.00';
                const dateStr = new Date(est.created_at).toLocaleDateString();
                const tr = document.createElement('tr');
                tr.className = 'lib-row';
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td class="font-bold">${est.ref_code}</td>
                    <td>${est.project_name}</td>
                    <td>${total}</td>
                    <td class="flex gap-2">
                        <button class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200" onclick="loadEstimate(${est.id})">Load</button>
                        <button class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold hover:bg-red-200" onclick="deleteEstimate(${est.id})">üóë</button>
                    </td>
                `;
                list.appendChild(tr);
            });
        }

        async function deleteEstimate(id) {
            if(!confirm("Are you sure you want to permanently delete this estimate?")) return;
            const { error } = await supabase.from('estimates').delete().eq('id', id);
            if(!error) {
                showToast("Estimate Deleted");
                openLibrary(); 
            } else {
                alert("Error deleting: " + error.message);
            }
        }

        function filterLibrary() {
            const term = document.getElementById('lib-search').value.toLowerCase();
            const filtered = libraryData.filter(est => est.ref_code.toLowerCase().includes(term) || est.project_name.toLowerCase().includes(term));
            renderLibrary(filtered);
        }

        function loadEstimate(id) {
            const est = libraryData.find(e => e.id === id);
            if(!est) return;
            const data = est.data;
            currentEstimateId = id;

            document.getElementById('quoteRef').value = data.ref;
            document.getElementById('projName').value = data.proj;
            document.getElementById('quoteDate').value = data.date;
            document.getElementById('colAddr').value = data.addresses.col;
            document.getElementById('siteAddr').value = data.addresses.site;
            document.getElementById('specificNotes').value = data.addresses.notes;
            document.getElementById('siteNotes').value = data.addresses.siteNotes;

            for (const [key, val] of Object.entries(data.inputs)) {
                const el = document.getElementById(key);
                if(el) { if(el.type === 'checkbox') el.checked = val; else el.value = val; }
            }

            const c = document.getElementById('custom-rows-container');
            c.innerHTML = '';
            data.rows.forEach(r => {
                c.insertAdjacentHTML('beforeend', `<tr class="text-xs border-b border-black"><td class="p-0"><textarea class="cell-input left" oninput="autoResize(this)">${r.desc}</textarea></td><td class="p-0"><input type="number" class="custom-qty cell-input" value="${r.qty}" oninput="calc()"></td><td class="p-0"><input type="number" class="custom-rate cell-input" value="${r.rate}" oninput="calc()"></td><td class="text-center custom-total">0.0</td></tr>`);
            });
            
            document.querySelectorAll('textarea').forEach(ta => autoResize(ta));
            document.getElementById('library-view').classList.add('hidden');
            calc();
            showToast(`Loaded: ${data.ref}`);
        }

        // RENDER & CALC
        function renderMainSheet() {
            const tContainer = document.getElementById('fixed-tasks-container');
            tContainer.innerHTML = '';
            config.tasks.forEach(t => {
                if(t.type === 'hrs') {
                    tContainer.innerHTML += `<tr><td class="bg-gray-50">${t.label}</td><td class="p-0"><input type="number" id="qty_${t.id}" class="cell-input" oninput="calc()"></td><td class="text-center text-gray-500">${t.val}</td><td class="text-center font-bold" id="tot_${t.id}">0.0</td></tr>`;
                } else if (t.type === 'hrs_check') {
                    tContainer.innerHTML += `<tr class="bg-row-yellow"><td colspan="3" class="font-bold flex items-center gap-2"><input type="checkbox" id="chk_${t.id}" onchange="calc()" class="w-4 h-4">${t.label} (+${t.val} hr/item)</td><td class="text-center font-bold" id="tot_${t.id}">0.0</td></tr>`;
                }
            });

            const lContainer = document.getElementById('labour-rows');
            lContainer.innerHTML = '';
            config.labour.forEach(l => {
                lContainer.innerHTML += `<tr><td class="bg-gray-50 pl-2">${l.label}</td><td class="p-0"><input type="number" id="qty_${l.id}" class="cell-input" oninput="calc()"></td><td class="text-center">¬£${l.val}</td><td class="p-0"><input type="number" id="days_${l.id}" class="cell-input" oninput="calc()"></td><td class="text-right pr-2 font-bold" id="tot_${l.id}">¬£0.00</td></tr>`;
            });

            const eContainer = document.getElementById('expenses-rows');
            eContainer.innerHTML = '';
            const gContainer = document.getElementById('globals-rows');
            gContainer.innerHTML = '';

            config.expenses.forEach(e => {
                if (e.label.includes("Parking") || e.label.includes("ULEZ") || e.label.includes("City")) {
                     gContainer.innerHTML += `<div class="grid grid-cols-[2fr_1fr_1fr] border-b border-black items-center h-8 ${e.label.includes('Parking') ? 'bg-gray-50' : ''}"><div class="px-2 font-bold flex items-center h-full">${e.label}</div><div class="p-0 h-full border-l border-black"><input type="number" id="qty_${e.id}" value="1" class="cell-input" oninput="calc()"></div><div class="px-2 text-right h-full flex items-center justify-end border-l border-black" id="tot_${e.id}">¬£0.00</div></div>`;
                } else {
                    eContainer.innerHTML += `<tr><td class="font-bold pl-2">${e.label}</td><td class="p-0"><input type="number" id="qty_${e.id}" class="cell-input" oninput="calc()"></td><td class="text-center">¬£${e.val}</td><td class="text-right pr-2" id="tot_${e.id}">¬£0.00</td></tr>`;
                }
            });

            const vContainer = document.getElementById('veh-rows');
            vContainer.innerHTML = '';
            config.vehicles.forEach((v, i) => {
                const isFirst = i===0 ? 'oninput="syncVehicleAreas(this.value)"' : 'class="cell-input veh-area-slave"';
                vContainer.innerHTML += `<tr><td class="bg-gray-50 pl-2 text-center">${v.label}</td><td class="text-center">¬£${v.val}</td><td class="p-0"><input type="number" id="qty_${v.id}" class="cell-input" oninput="calc()"></td><td class="p-0 border-l border-black"><input type="text" class="cell-input text-gray-500" value="London" ${isFirst}></td><td class="text-right pr-2 font-bold" id="tot_${v.id}">¬£0.00</td></tr>`;
            });

            document.getElementById('terms-display').innerText = config.terms;
            document.getElementById('lbl_dayHrs').innerText = config.globals.find(g=>g.id==='g1').val;
            document.getElementById('lbl_ooh').innerText = config.globals.find(g=>g.id==='g2').val;
            document.getElementById('lbl_sat').innerText = config.globals.find(g=>g.id==='g3').val;
            document.getElementById('lbl_sun').innerText = config.globals.find(g=>g.id==='g4').val;
        }

        function syncVehicleAreas(val) { document.querySelectorAll('.veh-area-slave').forEach(input => input.value = val); }

        function calc() {
            const val = (id) => parseFloat(document.getElementById(id)?.value) || 0;
            const setTxt = (id, v) => { if(document.getElementById(id)) document.getElementById(id).innerText = v; };

            let totalCustomQty = 0;
            let totalHrs = 0;

            document.querySelectorAll('#custom-rows-container tr').forEach(tr => {
                const qty = parseFloat(tr.querySelector('.custom-qty').value)||0;
                totalCustomQty += qty;
                const rate = parseFloat(tr.querySelector('.custom-rate').value)||0;
                const line = qty * rate;
                tr.querySelector('.custom-total').innerText = line ? line.toFixed(1) : "";
                totalHrs += line;
            });

            config.tasks.forEach(t => {
                let lineHrs = 0;
                if(t.type === 'hrs') lineHrs = val(`qty_${t.id}`) * t.val;
                else if (t.type === 'hrs_check') if(document.getElementById(`chk_${t.id}`)?.checked) lineHrs = totalCustomQty * t.val;
                setTxt(`tot_${t.id}`, lineHrs.toFixed(1));
                totalHrs += lineHrs;
            });

            const dayHrs = config.globals.find(g=>g.id==='g1').val;
            setTxt('grandTotalHrs', totalHrs.toFixed(1));
            setTxt('grandTotalDays', (totalHrs / dayHrs).toFixed(2));

            let totalMoney = 0;
            const globalDays = parseFloat(document.getElementById('manualGlobalDays').value) || 1;

            const processMoneyItem = (item) => {
                let lineCost = 0;
                const qty = val(`qty_${item.id}`);
                if(item.type === 'day') {
                    const rowDaysInput = document.getElementById(`days_${item.id}`);
                    const days = rowDaysInput ? (parseFloat(rowDaysInput.value)||0) : globalDays; 
                    lineCost = qty * days * item.val;
                } else {
                    lineCost = qty * item.val;
                }
                setTxt(`tot_${item.id}`, `¬£${lineCost.toFixed(2)}`);
                totalMoney += lineCost;
            };

            config.labour.forEach(processMoneyItem);
            config.vehicles.forEach(processMoneyItem);
            config.expenses.forEach(processMoneyItem);

            const oohMult = config.globals.find(g=>g.id==='g2').val;
            const satMult = config.globals.find(g=>g.id==='g3').val;
            const sunMult = config.globals.find(g=>g.id==='g4').val;
            
            setTxt('finalTotal', `¬£${totalMoney.toFixed(2)}`);
            setTxt('oohTotal', `¬£${(totalMoney * oohMult).toFixed(2)}`);
            setTxt('satTotal', `¬£${(totalMoney * satMult).toFixed(2)}`);
            setTxt('sunTotal', `¬£${(totalMoney * sunMult).toFixed(2)}`);
        }

        function addItemRow() {
            document.getElementById('custom-rows-container').insertAdjacentHTML('beforeend', `
            <tr class="text-xs border-b border-black">
                <td class="p-0"><textarea class="cell-input left" oninput="autoResize(this)"></textarea></td>
                <td class="p-0"><input type="number" class="custom-qty cell-input" value="1" oninput="calc()"></td>
                <td class="p-0"><input type="number" class="custom-rate cell-input" oninput="calc()"></td>
                <td class="text-center custom-total">0.0</td>
            </tr>`);
        }

        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

        // --- ADMIN ---
        function toggleAdmin() { 
            const el = document.getElementById('admin-view'); 
            if(el.classList.contains('hidden')) { renderAdminPanel(); el.classList.remove('hidden'); } else el.classList.add('hidden'); 
        }

        function renderAdminPanel() {
            const renderSection = (containerId, arrName) => {
                const c = document.getElementById(containerId);
                c.innerHTML = '';
                config[arrName].forEach((item, index) => {
                    if(arrName === 'globals') {
                        c.innerHTML += `<div class="admin-row"><span class="text-sm text-gray-300 col-span-2">${item.label}</span><input type="number" class="admin-input-num" value="${item.val}" onchange="updateConfigVal('${arrName}', ${index}, 'val', this.value)"><span></span></div>`;
                        return;
                    }
                    c.innerHTML += `<div class="admin-row"><input type="text" class="admin-input-text" value="${item.label}" onchange="updateConfigVal('${arrName}', ${index}, 'label', this.value)"><input type="number" class="admin-input-num" value="${item.val}" onchange="updateConfigVal('${arrName}', ${index}, 'val', this.value)"><select class="admin-select" onchange="updateConfigVal('${arrName}', ${index}, 'type', this.value)"><option value="day" ${item.type==='day'?'selected':''}>¬£/Day</option><option value="fixed" ${item.type==='fixed'?'selected':''}>¬£ Fixed</option><option value="hrs" ${item.type==='hrs'?'selected':''}>Hrs</option><option value="hrs_check" ${item.type==='hrs_check'?'selected':''}>Hrs(Chk)</option></select><div class="admin-btn-del" onclick="removeRow('${arrName}', ${index})">‚úï</div></div>`;
                });
            };
            renderSection('adm-labour-list', 'labour');
            renderSection('adm-tasks-list', 'tasks');
            renderSection('adm-vehicles-list', 'vehicles');
            renderSection('adm-expenses-list', 'expenses');
            renderSection('adm-globals-list', 'globals');
            document.getElementById('adm-terms-input').value = config.terms;
        }

        function updateConfigVal(arr, idx, field, val) { if(field === 'val') val = parseFloat(val); config[arr][idx][field] = val; }
        function addNewRow(arr) { const id = Date.now().toString().slice(-4); let type = arr === 'labour' ? 'day' : (arr === 'tasks' ? 'hrs' : 'fixed'); config[arr].push({ id: id, label: "New Item", val: 0, type: type }); renderAdminPanel(); }
        function removeRow(arr, idx) { config[arr].splice(idx, 1); renderAdminPanel(); }

        async function saveAdmin() {
            config.terms = document.getElementById('adm-terms-input').value;
            await supabase.from('app_settings').upsert({ id: 1, config: config });
            toggleAdmin();
            renderMainSheet();
            calc();
            showToast("Admin Settings Saved");
        }
        
        function resetDefaults() { if(confirm("Reset?")) { localStorage.removeItem('bh_est_config_v21'); location.reload(); } }

        function generatePDF() {
            saveEstimate('update');
            
            // Temporarily force light mode if in dark mode for PDF generation
            const wasDark = document.body.classList.contains('dark');
            if(wasDark) document.body.classList.remove('dark');

            const el = document.getElementById('ui-container');
            const page2 = document.getElementById('page-2');
            page2.classList.remove('hidden-on-screen');
            page2.classList.add('pdf-page-break');
            const btns = document.querySelectorAll('.no-print');
            btns.forEach(b => b.style.display = 'none');
            
            const ref = document.getElementById('quoteRef').value || "Estimate";
            const proj = document.getElementById('projName').value.replace(/[^a-z0-9]/gi, '-') || "Project";
            const date = document.getElementById('quoteDate').value;
            const filename = `${ref}_${proj}_${date}.pdf`;

            html2pdf().set({ margin: 0.2, filename: filename, image: { type: 'jpeg', quality: 1 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' } }).from(el).save().then(() => {
                 btns.forEach(b => b.style.display = '');
                 page2.classList.add('hidden-on-screen'); 
                 page2.classList.remove('pdf-page-break');
                 if(wasDark) document.body.classList.add('dark'); // Restore theme
            });
        }
    </script>
</body>
</html>
