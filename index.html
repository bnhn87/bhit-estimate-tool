<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BH Estimate Tool v28 (Fixed)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { orange: '#c26e30', dark: '#0e1118' },
                        gray: { 950: '#030712' },
                        slate: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        header: ['Oswald', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* APP STYLES */
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* SHEET CONTAINER */
        .sheet-container { 
            border: 2px solid #000; 
            background: #fff; 
            max-width: 1400px; 
            margin: 0 auto; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            margin-bottom: 2rem; 
        }
        .dark .sheet-container { border-color: #4b5563; background: #1f2937; }

        /* STRICT ALIGNMENT TABLES */
        table.strict-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        .strict-table th, .strict-table td { 
            border-right: 1px solid #000; 
            border-bottom: 1px solid #000; 
            padding: 4px 6px; 
            font-size: 12px; 
            vertical-align: middle; 
            height: 28px; 
        }
        
        .dark .strict-table th, .dark .strict-table td { border-color: #4b5563; }
        .strict-table tr:last-child td { border-bottom: 1px solid #000; }
        .dark .strict-table tr:last-child td { border-color: #4b5563; }
        .strict-table td:last-child, .strict-table th:last-child { border-right: none; }

        /* INPUTS */
        .cell-input { width: 100%; height: 100%; background: transparent; outline: none; text-align: center; font-family: inherit; font-size: inherit; color: inherit; }
        .cell-input.left { text-align: left; }
        .cell-input:focus { background-color: rgba(59, 130, 246, 0.1); }
        textarea.cell-input { resize: none; overflow: hidden; min-height: 1.2em; display: block; white-space: pre-wrap; line-height: 1.2; padding-top: 4px; }

        /* PDF TEMPLATE (Hidden normally) */
        #pdf-template { display: none; font-family: 'Inter', sans-serif; color: #000; background: #fff; width: 100%; max-width: 1100px; }
        #pdf-template h1, #pdf-template h2, #pdf-template h3, #pdf-template .header-title { font-family: 'Oswald', sans-serif; }
        
        /* UTILS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 50; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        /* TOAST */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* PRINT */
        @media print {
            body { background: white; margin: 0; color: black; }
            .no-print { display: none !important; }
            .sheet-container { box-shadow: none; margin: 0; width: 100%; max-width: none; border: none; }
            input, textarea, select { border: none; background: transparent; resize: none; appearance: none; color: black; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-950 dark:text-gray-100 p-4">

    <div class="max-w-[1400px] mx-auto flex justify-between items-center mb-4 bg-white dark:bg-gray-800 p-3 rounded shadow">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold">BH Estimate Tool v28</h1>
            <div class="text-xs flex items-center gap-2 text-gray-500 dark:text-gray-400">
                <span id="db-status" class="w-2.5 h-2.5 rounded-full bg-yellow-500"></span>
                <span id="db-text">Local Mode</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleTheme()" class="p-2 rounded border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"><i data-lucide="sun" class="w-4 h-4 dark:text-yellow-400"></i></button>
            <div class="h-6 w-px bg-gray-300 mx-2"></div>
            <button onclick="newEstimate()" class="px-3 py-1.5 text-xs font-bold bg-gray-200 text-gray-800 rounded hover:bg-gray-300">New</button>
            <button onclick="openLibrary()" class="px-3 py-1.5 text-xs font-bold bg-purple-600 text-white rounded hover:bg-purple-700">Library</button>
            <button onclick="saveEstimate('update')" class="px-3 py-1.5 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            <button onclick="saveEstimate('revision')" class="px-3 py-1.5 text-xs font-bold bg-green-600 text-white rounded hover:bg-green-700">Rev+</button>
            <div class="h-6 w-px bg-gray-300 mx-2"></div>
            <button onclick="toggleAdmin()" class="px-3 py-1.5 text-xs font-bold bg-gray-800 text-white rounded hover:bg-gray-900">Admin</button>
            <button onclick="generatePDF()" class="px-3 py-1.5 text-xs font-bold bg-brand-orange text-white rounded shadow-lg hover:bg-orange-700 flex items-center gap-1"><i data-lucide="download" class="w-3 h-3"></i> Download PDF</button>
        </div>
    </div>

    <div id="ui-container" class="sheet-container">
        <div class="text-center py-4 border-b-2 border-black dark:border-gray-600 relative">
            <img id="logo-display" class="h-12 absolute left-4 top-4 hidden object-contain" alt="Logo">
            <h1 class="text-3xl font-bold header-font">BH Installation & Transport</h1>
        </div>

        <div class="grid grid-cols-[1fr_2fr_1fr_1fr] border-b-2 border-black dark:border-gray-600 divide-x divide-black dark:divide-gray-600">
            <div class="p-2 font-bold text-xs bg-gray-200 dark:bg-gray-700 flex items-center">Estimate Ref:</div>
            <div class="p-0"><input type="text" id="quoteRef" class="cell-input left font-bold px-2" placeholder="Ref..."></div>
            <div class="p-2 font-bold text-xs text-right bg-gray-200 dark:bg-gray-700 flex items-center justify-end">Date:</div>
            <div class="p-0"><input type="date" id="quoteDate" class="cell-input px-2 text-right"></div>
        </div>
        <div class="grid grid-cols-[1fr_2fr_1fr_2fr] border-b-2 border-black dark:border-gray-600 divide-x divide-black dark:divide-gray-600">
            <div class="p-2 font-bold text-xs bg-gray-200 dark:bg-gray-700 flex items-center">Client:</div>
            <div class="p-0"><input type="text" id="clientName" class="cell-input left font-bold px-2" placeholder="Client Name..."></div>
            <div class="p-2 font-bold text-xs bg-gray-200 dark:bg-gray-700 flex items-center">Project:</div>
            <div class="p-0"><input type="text" id="projName" class="cell-input left font-bold px-2" placeholder="Project Name..."></div>
        </div>

        <div class="flex border-b-2 border-black dark:border-gray-600">
            <div class="w-full flex">
                <div class="bg-orange-200 dark:bg-orange-900 font-bold text-xs p-2 flex items-center border-r border-black dark:border-gray-600 w-1/3">Estimate valid to (90 days):</div>
                <div class="font-bold text-xs p-2 bg-white dark:bg-gray-900 flex-grow flex items-center" id="validDate"></div>
            </div>
        </div>

        <div class="flex border-b-2 border-black dark:border-gray-600">
            
            <div class="w-5/12 border-r-2 border-black dark:border-gray-600 flex flex-col">
                <table class="strict-table">
                    <colgroup><col style="width: 50%"><col style="width: 15%"><col style="width: 15%"><col style="width: 20%"></colgroup>
                    <thead><tr class="text-xs bg-blue-100 dark:bg-blue-900"><th>Items</th><th>Qty</th><th>Hrs</th><th>Total</th></tr></thead>
                    <tbody id="custom-rows-container"></tbody>
                </table>
                
                <div class="no-print p-1 text-center bg-gray-50 dark:bg-gray-800 space-x-2 border-b border-black dark:border-gray-600">
                    <button onclick="addItemRow()" class="text-[10px] text-blue-600 font-bold">+ Row</button>
                    <button onclick="openPasteFromGPT()" class="text-[10px] text-amber-600 font-bold">Paste Table</button>
                </div>

                <table class="strict-table border-b-2 border-black dark:border-gray-600">
                    <colgroup><col style="width: 50%"><col style="width: 15%"><col style="width: 15%"><col style="width: 20%"></colgroup>
                    <tbody id="fixed-tasks-container" class="text-xs"></tbody>
                </table>
                
                <div class="bg-gray-100 dark:bg-gray-800 border-b border-black dark:border-gray-600 p-2 flex justify-between items-center font-bold text-sm">
                    <span>Total Hours</span><span id="grandTotalHrs">0.0</span>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/30 p-2 flex justify-between items-center border-b border-black dark:border-gray-600">
                    <span class="text-xs font-bold">Manual Days on Site:</span>
                    <input type="number" id="manualGlobalDays" value="1" class="w-16 text-center border border-gray-400 rounded bg-white dark:bg-gray-900 font-bold" oninput="calc()">
                </div>
                
                <div class="flex-grow flex flex-col bg-blue-50 dark:bg-blue-900/20 min-h-[150px]">
                    <div class="p-1 text-[10px] font-bold border-b border-gray-300 dark:border-gray-600 mx-2 mt-1 opacity-70">Site notes / Scope of works</div>
                    <textarea id="siteNotes" class="w-full flex-grow bg-transparent p-2 text-sm resize-none outline-none">Installation of products as detailed in the supplied Works Order...</textarea>
                </div>
            </div>

            <div class="w-7/12 flex flex-col">
                <div class="flex h-24 border-b-2 border-black dark:border-gray-600">
                    <div class="w-1/2 border-r border-black dark:border-gray-600 p-2 flex flex-col bg-blue-50 dark:bg-blue-900/10">
                        <div class="text-[10px] font-bold mb-1 text-center border-b border-gray-300 dark:border-gray-600">Collection Address</div>
                        <textarea id="colAddr" class="w-full flex-grow bg-transparent resize-none text-xs text-center font-bold" placeholder="Enter Collection..."></textarea>
                    </div>
                    <div class="w-1/2 p-2 flex flex-col bg-blue-50 dark:bg-blue-900/10">
                        <div class="text-[10px] font-bold mb-1 text-center border-b border-gray-300 dark:border-gray-600">Site Address</div>
                        <textarea id="siteAddr" class="w-full flex-grow bg-transparent resize-none text-xs text-center font-bold" placeholder="Enter Site Address..."></textarea>
                    </div>
                </div>
                
                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 h-20 border-b border-black dark:border-gray-600">
                     <textarea id="specificNotes" class="w-full h-full bg-transparent resize-none text-xs placeholder-yellow-600 dark:placeholder-yellow-500 outline-none" placeholder="Site specific notes..."></textarea>
                </div>

                <table class="strict-table">
                    <colgroup><col style="width: 40%"><col style="width: 15%"><col style="width: 15%"><col style="width: 15%"><col style="width: 15%"></colgroup>
                    
                    <thead><tr class="bg-gray-200 dark:bg-gray-700 text-xs font-bold"><th>Role</th><th>Installers</th><th>Cost/Day</th><th>Days</th><th>Total</th></tr></thead>
                    <tbody id="labour-rows" class="text-xs"></tbody>

                    <thead><tr class="bg-gray-200 dark:bg-gray-700 text-xs font-bold"><th colspan="5" class="text-left pl-2">Expenses</th></tr></thead>
                    <tbody id="expenses-rows" class="text-xs"></tbody>

                    <thead><tr class="bg-gray-200 dark:bg-gray-700 text-xs font-bold"><th>Vehicle</th><th>Cost</th><th>Qty</th><th>Area</th><th>Total</th></tr></thead>
                    <tbody id="veh-rows" class="text-xs"></tbody>
                </table>

                <div class="flex flex-grow">
                    <div class="w-7/12 border-r border-black dark:border-gray-600" id="globals-rows"></div>
                    
                    <div class="w-5/12 bg-orange-100 dark:bg-orange-900/40 flex flex-col justify-end p-2">
                        <div class="flex justify-between text-lg font-bold border-b border-black dark:border-gray-600 pb-1">
                            <span>Total</span><span id="finalTotal">£0.00</span>
                        </div>
                        <div class="text-[10px] space-y-1 mt-1 opacity-80 font-mono">
                            <div class="flex justify-between"><span>OOH (x<span id="lbl_ooh">1.6</span>)</span><span id="oohTotal">£0.00</span></div>
                            <div class="flex justify-between"><span>Sat (x<span id="lbl_sat">1.75</span>)</span><span id="satTotal">£0.00</span></div>
                            <div class="flex justify-between"><span>Sun (x<span id="lbl_sun">2.0</span>)</span><span id="sunTotal">£0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="border-t-2 border-black dark:border-gray-600 flex bg-white dark:bg-gray-900">
            <div class="w-8/12 p-2 text-[10px] leading-tight border-r-2 border-black dark:border-gray-600 text-gray-500">
                <strong>Note:</strong> T&Cs are attached on the following page.
            </div>
            <div class="w-4/12 flex flex-col">
                <div class="text-[10px] font-bold text-center border-b border-black dark:border-gray-600 p-1 bg-gray-100 dark:bg-gray-800">Estimate Issued By</div>
                <div class="flex-grow flex items-center justify-center p-2">
                    <input type="text" value="Ben Hone" class="text-center font-bold text-xl w-full bg-transparent focus:outline-none">
                </div>
            </div>
        </div>
    </div>

    <div id="pdf-template">
        <div class="w-full h-2 bg-[#c26e30]"></div>
        <div class="p-8 flex justify-between items-center border-b border-gray-200">
            <div class="flex items-center gap-4"><img id="pdf-logo" class="w-16 h-16 object-contain hidden"></div>
            <div class="text-right">
                <h2 class="text-3xl font-bold uppercase tracking-tight font-header"><span class="text-[#c26e30]">Estimate</span> <span class="text-gray-400 text-lg"> // </span> <span id="pdf-ref" class="text-gray-800 font-mono">REF</span></h2>
                <div class="mt-1 text-xs text-gray-500 font-sans"><p>Date Issued: <span id="pdf-date" class="text-gray-900 font-semibold"></span></p><p>Valid Until: <span id="pdf-valid" class="text-gray-900"></span></p></div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-8 px-8 py-6 bg-gray-50 border-b border-gray-200 text-sm font-sans">
            <div><p class="text-xs uppercase text-gray-400 tracking-wider mb-1">Estimate For</p><p id="pdf-client" class="text-lg font-bold text-gray-900">Client Name</p><p id="pdf-site-addr" class="text-gray-600 whitespace-pre-wrap">Site Address...</p></div>
            <div class="text-right"><p class="text-xs uppercase text-gray-400 tracking-wider mb-1">Project</p><p id="pdf-project" class="text-lg font-bold text-gray-900">Project Name</p><p class="text-gray-500 italic">Prepared by: BH Installation & Transport</p></div>
        </div>
        <div class="p-8 space-y-8 font-sans">
            <section><h3 class="text-[#c26e30] text-xs font-bold uppercase tracking-widest mb-2">Scope of Works</h3><div id="pdf-scope" class="p-4 bg-gray-50 border border-gray-200 rounded text-sm text-gray-700 whitespace-pre-wrap leading-relaxed"></div></section>
            <section>
                <div class="flex justify-between items-end mb-2"><h3 class="text-[#c26e30] text-xs font-bold uppercase tracking-widest">Breakdown</h3></div>
                <table class="w-full text-sm border border-gray-200 rounded overflow-hidden">
                    <thead class="bg-gray-800 text-white text-xs uppercase"><tr><th class="px-4 py-2 text-left">Description</th><th class="px-4 py-2 text-center w-16">Qty</th><th class="px-4 py-2 text-center w-16">Hrs</th><th class="px-4 py-2 text-right w-24">Total Hrs</th></tr></thead>
                    <tbody id="pdf-item-rows" class="divide-y divide-gray-100 text-gray-700"></tbody>
                    <tfoot class="bg-gray-50 font-bold text-gray-900"><tr><td colspan="3" class="px-4 py-2 text-right text-xs uppercase text-gray-500">Total Est. Hours</td><td id="pdf-total-hrs" class="px-4 py-2 text-right text-[#c26e30]">0.0</td></tr></tfoot>
                </table>
            </section>
            <section class="grid grid-cols-2 gap-6">
                <div class="text-xs"><h4 class="font-bold text-gray-900 border-b border-gray-200 pb-1 mb-2">Supplementary & Labour</h4><ul id="pdf-charges-list" class="space-y-1 text-gray-600"></ul></div>
                <div class="space-y-4">
                    <div class="bg-gray-800 text-white p-4 rounded border border-gray-700"><p class="text-xs uppercase text-gray-400 tracking-wider">Total Estimated Cost (ex VAT)</p><p id="pdf-final-total" class="text-3xl font-bold text-[#c26e30]">£0.00</p></div>
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 flex justify-between items-center"><span class="text-xs uppercase text-gray-500 font-bold">Est. Labour Days</span><span id="pdf-labour-days" class="text-sm font-mono font-bold text-gray-900">0.0</span></div>
                </div>
            </section>
            <section class="mt-8 pt-8 border-t border-gray-200 text-[10px] text-gray-500 leading-relaxed"><h3 class="text-[#c26e30] font-bold uppercase tracking-widest mb-2">Terms & Conditions</h3><div id="pdf-terms" class="whitespace-pre-wrap text-justify"></div><div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center"><strong>BHi - Your Plan. Delivered.</strong><span>Tel: 07862043271 &middot; Email: info@bhit.uk</span></div></section>
        </div>
    </div>

    <div id="library-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-900 p-6 rounded-lg w-[600px] max-h-[80vh] flex flex-col shadow-2xl border dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Estimate Library</h2>
                <button onclick="document.getElementById('library-modal').classList.add('hidden')" class="text-gray-500 hover:text-red-500"><i data-lucide="x"></i></button>
            </div>
            <div id="library-list" class="overflow-y-auto flex-grow space-y-2 pr-2">Loading...</div>
        </div>
    </div>

    <div id="paste-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-900 p-6 rounded-lg w-[600px] shadow-2xl border dark:border-gray-700">
            <h2 class="text-xl font-bold mb-2">Paste Data from GPT/Excel</h2>
            <p class="text-xs text-gray-500 mb-2">Format: Description | Qty | Rate</p>
            <textarea id="paste-area" class="w-full h-40 border p-2 text-xs font-mono mb-4 bg-gray-50 dark:bg-gray-800" placeholder="Paste rows here..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('paste-modal').classList.add('hidden')" class="px-3 py-1 bg-gray-300 rounded text-sm">Cancel</button>
                <button onclick="processPaste()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Import Rows</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-900 p-6 rounded-lg w-[800px] max-h-[90vh] overflow-y-auto shadow-2xl border dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Global Configuration</h2>
                <div class="flex gap-2">
                    <button onclick="saveConfig()" class="px-3 py-1 bg-green-600 text-white rounded text-xs font-bold">Save Config</button>
                    <button onclick="toggleAdmin()" class="text-gray-500 hover:text-red-500"><i data-lucide="x"></i></button>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="font-bold border-b mb-2">Logo URL</h3>
                    <input type="text" id="cfg-logo" class="w-full border p-1 mb-2 text-xs" placeholder="https://...">
                    <img id="admin-logo-preview" class="h-10 object-contain bg-gray-100">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-bold border-b mb-2">Global Multipliers</h3>
                        <div id="cfg-globals" class="space-y-1"></div>
                    </div>
                    <div>
                         <h3 class="font-bold border-b mb-2">Terms & Conditions</h3>
                         <textarea id="cfg-terms" class="w-full h-32 border p-1 text-xs"></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-bold border-b mb-2 flex justify-between">Labour Rates <button onclick="addConfigRow('labour')" class="text-blue-600 text-[10px]">+Add</button></h3>
                        <div id="cfg-labour" class="space-y-1"></div>
                    </div>
                    <div>
                        <h3 class="font-bold border-b mb-2 flex justify-between">Vehicles <button onclick="addConfigRow('vehicles')" class="text-blue-600 text-[10px]">+Add</button></h3>
                        <div id="cfg-vehicles" class="space-y-1"></div>
                    </div>
                    <div>
                        <h3 class="font-bold border-b mb-2 flex justify-between">Fixed Tasks (Hrs) <button onclick="addConfigRow('tasks')" class="text-blue-600 text-[10px]">+Add</button></h3>
                        <div id="cfg-tasks" class="space-y-1"></div>
                    </div>
                    <div>
                        <h3 class="font-bold border-b mb-2 flex justify-between">Expenses <button onclick="addConfigRow('expenses')" class="text-blue-600 text-[10px]">+Add</button></h3>
                        <div id="cfg-expenses" class="space-y-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast">Saved!</div>

    <script>
        const PROJECT_URL = 'https://wgsqrjnliglemogtukly.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indnc3Fyam5saWdsZW1vZ3R1a2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5ODY2MTIsImV4cCI6MjA3OTU2MjYxMn0.chlJ9Ba2kQDu_xnqMfwcRwv5pgiwHnv7FJJSzKxbPeM';
        const supabase = window.supabase.createClient(PROJECT_URL, ANON_KEY);

        const DEFAULT_TERMS = `1. All estimates are supplied on the assumption of clear access, use of appropriate size lift, which will accomodate ALL items, for uplift and clear working areas.
2. Waste will be disposed of by a licensed waste carrier.`;
        
        const DEFAULT_CONFIG = {
            labour: [
                { id: 'l1', label: "Installer + Veh", val: 325, type: 'day' },
                { id: 'l2', label: "2 Person Team", val: 550, type: 'day' },
                { id: 'l3', label: "Installer On Foot", val: 185, type: 'day' },
                { id: 'l4', label: "Supervisor", val: 220, type: 'day' },
                { id: 'l5', label: "Custom/Snag", val: 750, type: 'day' }
            ],
            vehicles: [
                { id: 'v1', label: "SWB Van", val: 170, type: 'fixed' },
                { id: 'v2', label: "XLWB Van", val: 200, type: 'fixed' },
                { id: 'v3', label: "Luton Van", val: 230, type: 'fixed' },
                { id: 'v4', label: "7.5T Truck", val: 540, type: 'fixed' },
                { id: 'v5', label: "18T Truck", val: 720, type: 'fixed' }
            ],
            tasks: [
                { id: 't1', label: "Standard Uplift", val: 0.3, type: 'hrs' },
                { id: 't2', label: "Unwrap/Level", val: 0.2, type: 'hrs' },
                { id: 't3', label: "Extended Uplift", val: 0.5, type: 'hrs_check' },
                { id: 't4', label: "Stairs (per Item)", val: 0.1, type: 'hrs_check' }
            ],
            expenses: [
                { id: 'e1', label: "Additional Miles", val: 0.90, type: 'fixed' },
                { id: 'e2', label: "Waste Disposal", val: 340, type: 'fixed' },
                { id: 'e3', label: "ULEZ/City Charge", val: 15, type: 'fixed' },
                { id: 'e4', label: "Parking Cost", val: 75, type: 'day' }
            ],
            globals: [
                { id: 'g1', label: "Working Day Hours", val: 7.25 },
                { id: 'g2', label: "OOH Multiplier", val: 1.6 },
                { id: 'g3', label: "Sat Multiplier", val: 1.75 },
                { id: 'g4', label: "Sun Multiplier", val: 2.0 }
            ],
            terms: DEFAULT_TERMS, logo: ""
        };

        let config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
        let currentEstimateId = null;

        window.onload = async function() {
            lucide.createIcons();
            if(localStorage.getItem('bh_theme') === 'dark') document.body.classList.add('dark');
            
            addItemRow();
            renderMainSheet();
            document.getElementById('quoteDate').valueAsDate = new Date();
            calc();

            await loadSharedConfig();
        };

        async function loadSharedConfig() {
            try {
                const { data } = await supabase.from('app_settings').select('*').eq('id', 1).single();
                if (data && data.config && data.config.labour) {
                    config = data.config;
                    renderMainSheet(); 
                    calc();
                    document.getElementById('db-status').className = "w-2.5 h-2.5 rounded-full bg-green-500";
                    document.getElementById('db-text').innerText = "Cloud Connected";
                    if(config.logo) document.getElementById('admin-logo-preview').src = config.logo;
                }
            } catch (e) { console.log("Offline mode"); }
        }

        // --- CALCULATION ---
        const fmtMoney = (v) => `£${parseFloat(v).toFixed(2)}`;
        
        function calc() {
            let h=0, m=0;
            const val = (id) => parseFloat(document.getElementById(id)?.value)||0;
            
            // Items
            document.querySelectorAll('#custom-rows-container tr').forEach(tr=>{
                const q=parseFloat(tr.querySelector('.custom-qty').value)||0;
                const r=parseFloat(tr.querySelector('.custom-rate').value)||0;
                tr.querySelector('.custom-total').innerText = (q*r).toFixed(1); 
                h+=(q*r);
            });
            
            // Tasks
            config.tasks.forEach(t=>{
                let v=0;
                if(t.type==='hrs') v=val(`qty_${t.id}`)*t.val;
                else if(t.type==='hrs_check' && document.getElementById(`chk_${t.id}`)?.checked) v=val('custom-rows-container').childElementCount * t.val;
                if(document.getElementById(`tot_${t.id}`)) document.getElementById(`tot_${t.id}`).innerText=v.toFixed(1); h+=v;
            });
            
            const dayHrs = config.globals.find(g=>g.label.includes("Hours"))?.val || 7.25;
            document.getElementById('grandTotalHrs').innerText=h.toFixed(1);
            document.getElementById('grandTotalDays').innerText=(h/dayHrs).toFixed(2);
            const manDays = val('manualGlobalDays');

            // Costs
            [config.labour, config.vehicles, config.expenses].flat().forEach(i=>{
                let c=0, q=val(`qty_${i.id}`);
                if(i.type==='day') { 
                    const dInp=document.getElementById(`days_${i.id}`);
                    c = q * (dInp ? (parseFloat(dInp.value)||0) : manDays) * i.val;
                } else c = q * i.val;
                if(document.getElementById(`tot_${i.id}`)) document.getElementById(`tot_${i.id}`).innerText = fmtMoney(c);
                m+=c;
            });
            
            document.getElementById('finalTotal').innerText = fmtMoney(m);
            const ooh = config.globals.find(g=>g.label.includes("OOH"))?.val || 1.6;
            const sat = config.globals.find(g=>g.label.includes("Sat"))?.val || 1.75;
            const sun = config.globals.find(g=>g.label.includes("Sun"))?.val || 2.0;
            document.getElementById('oohTotal').innerText = fmtMoney(m*ooh);
            document.getElementById('satTotal').innerText = fmtMoney(m*sat);
            document.getElementById('sunTotal').innerText = fmtMoney(m*sun);
            
            // Update multipliers display
            document.getElementById('lbl_ooh').innerText = ooh;
            document.getElementById('lbl_sat').innerText = sat;
            document.getElementById('lbl_sun').innerText = sun;
        }

        function renderMainSheet() {
            const tC=document.getElementById('fixed-tasks-container'); tC.innerHTML=''; 
            config.tasks.forEach(t=>{ tC.innerHTML+=t.type==='hrs'?`<tr><td class="bg-gray-50 dark:bg-gray-800 border-color-inherit">${t.label}</td><td class="p-0"><input type="number" id="qty_${t.id}" class="cell-input" oninput="calc()"></td><td class="text-center text-gray-500">${t.val}</td><td class="text-center font-bold" id="tot_${t.id}">0.0</td></tr>`:`<tr class="bg-yellow-50 dark:bg-amber-950/40 border-color-inherit print-bg-yellow"><td colspan="3" class="font-bold flex items-center gap-2 pl-2"><input type="checkbox" id="chk_${t.id}" onchange="calc()" class="w-4 h-4 accent-blue-600">${t.label} (+${t.val} hr/item)</td><td class="text-center font-bold" id="tot_${t.id}">0.0</td></tr>`; });

            const lC=document.getElementById('labour-rows'); lC.innerHTML=''; 
            config.labour.forEach(l=>lC.innerHTML+=`<tr><td class="bg-gray-50 dark:bg-gray-800 pl-2 border-color-inherit">${l.label}</td><td class="p-0"><input type="number" id="qty_${l.id}" class="cell-input" oninput="calc()"></td><td class="text-center">£${l.val}</td><td class="p-0"><input type="number" id="days_${l.id}" class="cell-input" oninput="calc()"></td><td class="text-right pr-2 font-bold" id="tot_${l.id}">£0.00</td></tr>`);

            const eC=document.getElementById('expenses-rows'); eC.innerHTML=''; 
            const gC=document.getElementById('globals-rows'); gC.innerHTML='';

            config.expenses.forEach(e => {
                if (e.label.includes("Parking") || e.label.includes("ULEZ") || e.label.includes("City")) {
                     gC.innerHTML += `<div class="grid grid-cols-[2fr_1fr_1fr] border-b border-black dark:border-gray-500 items-center h-8 ${e.label.includes('Parking') ? 'bg-gray-50 dark:bg-gray-800' : ''}"><div class="px-2 font-bold flex items-center h-full">${e.label}</div><div class="p-0 h-full border-l border-black dark:border-gray-500"><input type="number" id="qty_${e.id}" value="1" class="cell-input" oninput="calc()"></div><div class="px-2 text-right h-full flex items-center justify-end border-l border-black dark:border-gray-500" id="tot_${e.id}">£0.00</div></div>`;
                } else {
                    eC.innerHTML += `<tr><td class="font-bold pl-2 border-color-inherit">${e.label}</td><td class="p-0"><input type="number" id="qty_${e.id}" class="cell-input" oninput="calc()"></td><td class="text-center">£${e.val}</td><td class="text-right pr-2" id="tot_${e.id}">£0.00</td></tr>`;
                }
            });

            const vC=document.getElementById('veh-rows'); vC.innerHTML=''; 
            config.vehicles.forEach((v,i)=>{ const first=i===0?'oninput="syncVehicleAreas(this.value)"':'class="cell-input veh-area-slave"'; vC.innerHTML+=`<tr><td class="bg-gray-50 dark:bg-gray-800 pl-2 text-center border-color-inherit">${v.label}</td><td class="text-center">£${v.val}</td><td class="p-0"><input type="number" id="qty_${v.id}" class="cell-input" oninput="calc()"></td><td class="p-0 border-l border-black dark:border-gray-500"><input type="text" class="cell-input text-gray-500" value="London" ${first}></td><td class="text-right pr-2 font-bold" id="tot_${v.id}">£0.00</td></tr>`; });

            document.getElementById('validDate').innerText = new Date(Date.now() + 90*24*60*60*1000).toLocaleDateString();
            if(config.logo) document.getElementById('logo-display').src = config.logo;
        }

        function syncVehicleAreas(val) { document.querySelectorAll('.veh-area-slave').forEach(input => input.value = val); }
        function addItemRow(desc="", qty="1", rate="") { 
            document.getElementById('custom-rows-container').insertAdjacentHTML('beforeend', `<tr class="text-xs border-b group border-black dark:border-gray-600"><td class="p-0"><textarea class="cell-input left">${desc}</textarea></td><td class="p-0"><input type="number" class="custom-qty cell-input" value="${qty}" oninput="calc()"></td><td class="p-0"><input type="number" class="custom-rate cell-input" value="${rate}" oninput="calc()"></td><td class="text-center custom-total">0.0</td><td class="border-none text-center"><button onclick="this.closest('tr').remove();calc()" class="text-red-500 opacity-0 group-hover:opacity-100">x</button></td></tr>`);
        }
        function toggleTheme(){ const b=document.body; b.classList.toggle('dark'); localStorage.setItem('bh_theme', b.classList.contains('dark')?'dark':'light'); }
        
        // --- GENERATE PDF ---
        function generatePDF(){
            const wasDark = document.body.classList.contains('dark'); if(wasDark) document.body.classList.remove('dark');
            const el = document.getElementById('ui-container'); 
            const tpl = document.getElementById('pdf-template');
            
            // Fill Template
            document.getElementById('pdf-ref').innerText=document.getElementById('quoteRef').value;
            document.getElementById('pdf-date').innerText=document.getElementById('quoteDate').value;
            document.getElementById('pdf-valid').innerText=document.getElementById('validDate').innerText;
            document.getElementById('pdf-client').innerText=document.getElementById('clientName').value;
            document.getElementById('pdf-project').innerText=document.getElementById('projName').value;
            document.getElementById('pdf-site-addr').innerText=document.getElementById('siteAddr').value;
            document.getElementById('pdf-scope').innerText=document.getElementById('siteNotes').value;
            if(config.logo) {document.getElementById('pdf-logo').src=config.logo;document.getElementById('pdf-logo').classList.remove('hidden');}
            
            const tb=document.getElementById('pdf-item-rows');tb.innerHTML='';
            document.querySelectorAll('#custom-rows-container tr').forEach(tr=>{const d=tr.querySelector('textarea').value;if(d)tb.innerHTML+=`<tr><td class="px-4 py-2">${d}</td><td class="text-center">${tr.querySelector('.custom-qty').value}</td><td class="text-center">${tr.querySelector('.custom-rate').value}</td><td class="text-right">${tr.querySelector('.custom-total').innerText}</td></tr>`;});
            document.getElementById('pdf-total-hrs').innerText=document.getElementById('grandTotalHrs').innerText;
            
            const cl=document.getElementById('pdf-charges-list');cl.innerHTML='';
            config.labour.concat(config.vehicles,config.expenses).forEach(i=>{const v=parseFloat(document.getElementById(`tot_${i.id}`).innerText.replace('£',''))||0;if(v>0)cl.innerHTML+=`<li class="flex justify-between"><span>${i.label}</span><span>${fmtMoney(v)}</span></li>`;});
            
            document.getElementById('pdf-final-total').innerText=document.getElementById('finalTotal').innerText;
            document.getElementById('pdf-labour-days').innerText=document.getElementById('grandTotalDays').innerText;
            document.getElementById('pdf-terms').innerText=config.terms;

            tpl.style.display='block';
            html2pdf().set({margin:0,filename:`${document.getElementById('quoteRef').value}.pdf`,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'in',format:'a4',orientation:'portrait'}}).from(tpl).save().then(()=>{
                tpl.style.display='none';
                if(wasDark)document.body.classList.add('dark');
                saveEstimate('update'); 
            });
        }

        // --- SAVE / LOAD / ADMIN RESTORED ---
        
        // 1. LIBRARY
        async function openLibrary() {
            document.getElementById('library-modal').classList.remove('hidden');
            document.getElementById('library-list').innerHTML = "Loading...";
            const { data } = await supabase.from('estimates').select('id, ref_code, project_name, created_at').order('created_at', { ascending: false }).limit(20);
            if (!data) { document.getElementById('library-list').innerHTML = "Error loading."; return; }
            document.getElementById('library-list').innerHTML = data.map(e => `
                <div class="flex justify-between items-center p-2 border-b hover:bg-gray-100 dark:hover:bg-gray-800">
                    <div><div class="font-bold">${e.ref_code}</div><div class="text-xs">${e.project_name}</div></div>
                    <div class="flex gap-2">
                        <button onclick="loadEstimate('${e.id}')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">Load</button>
                        <button onclick="deleteEstimate('${e.id}')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">Del</button>
                    </div>
                </div>`).join('');
        }
        
        async function loadEstimate(id) {
            const { data } = await supabase.from('estimates').select('*').eq('id', id).single();
            if(!data) return;
            currentEstimateId = data.id;
            const d = data.data;
            document.getElementById('quoteRef').value = data.ref_code;
            document.getElementById('projName').value = data.project_name;
            document.getElementById('clientName').value = d.client;
            document.getElementById('quoteDate').value = d.date;
            document.getElementById('colAddr').value = d.addresses.col || "";
            document.getElementById('siteAddr').value = d.addresses.site || "";
            document.getElementById('specificNotes').value = d.addresses.notes || "";
            document.getElementById('siteNotes').value = d.addresses.siteNotes || "";
            
            document.getElementById('custom-rows-container').innerHTML = "";
            d.rows.forEach(r => addItemRow(r.desc, r.qty, r.rate));
            
            Object.keys(d.inputs).forEach(k => {
                const el = document.getElementById(k);
                if(el) { if(el.type==='checkbox') el.checked=d.inputs[k]; else el.value=d.inputs[k]; }
            });
            calc();
            document.getElementById('library-modal').classList.add('hidden');
            showToast("Loaded");
        }

        async function deleteEstimate(id) {
            if(!confirm("Delete?")) return;
            await supabase.from('estimates').delete().eq('id', id);
            openLibrary();
        }

        // 2. SAVE
        async function saveEstimate(m){
            const r=document.getElementById('quoteRef').value||"Draft";
            const p=document.getElementById('projName').value||"Untitled";
            
            if(m==='revision'){ 
                const mx=r.match(/-REV(\d+)$/); 
                const nextRef = mx ? r.replace(/-REV\d+$/, `-REV${parseInt(mx[1])+1}`) : `${r}-REV1`; 
                document.getElementById('quoteRef').value = nextRef; 
                currentEstimateId=null; 
            }
            
            const d={
                ref:document.getElementById('quoteRef').value,
                proj:p,
                client:document.getElementById('clientName').value,
                date:document.getElementById('quoteDate').value,
                total:document.getElementById('finalTotal').innerText,
                rows:[],
                inputs:{},
                addresses:{
                    col:document.getElementById('colAddr').value,
                    site:document.getElementById('siteAddr').value,
                    notes:document.getElementById('specificNotes').value,
                    siteNotes:document.getElementById('siteNotes').value
                }
            };
            document.querySelectorAll('#custom-rows-container tr').forEach(tr=>d.rows.push({
                desc:tr.querySelector('textarea').value,
                qty:tr.querySelector('.custom-qty').value,
                rate:tr.querySelector('.custom-rate').value
            }));
            document.querySelectorAll('input').forEach(el=>{if(el.id)d.inputs[el.id]=el.type==='checkbox'?el.checked:el.value;});
            
            if(m==='update' && currentEstimateId) await supabase.from('estimates').update({ref_code:d.ref, project_name:p, data:d}).eq('id',currentEstimateId);
            else { const{data}=await supabase.from('estimates').insert({ref_code:d.ref, project_name:p, data:d}).select(); if(data)currentEstimateId=data[0].id; }
            showToast("Saved");
        }

        // 3. PASTE
        function openPasteFromGPT() { document.getElementById('paste-modal').classList.remove('hidden'); }
        function processPaste() {
            const txt = document.getElementById('paste-area').value;
            const rows = txt.split(/\r?\n/);
            rows.forEach(row => {
                const cols = row.split('|');
                if(cols.length >= 1) addItemRow(cols[0].trim(), cols[1]?.trim()||1, cols[2]?.trim()||0);
            });
            document.getElementById('paste-modal').classList.add('hidden');
            calc();
        }

        // 4. ADMIN
        function toggleAdmin() {
            const modal = document.getElementById('admin-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) renderAdmin();
        }
        
        function renderAdmin() {
            document.getElementById('cfg-logo').value = config.logo || "";
            document.getElementById('cfg-terms').value = config.terms || "";
            document.getElementById('cfg-globals').innerHTML = config.globals.map(g => `<div class="flex justify-between items-center text-xs"><span class="w-1/2">${g.label}</span><input type="number" id="adm_g_${g.id}" value="${g.val}" class="border w-16 text-center"></div>`).join('');
            
            const ren = (arr, idPrefix, target) => {
                document.getElementById(target).innerHTML = arr.map((item, idx) => `
                    <div class="grid grid-cols-[3fr_1fr_20px] gap-1 items-center mb-1 text-xs">
                        <input type="text" id="${idPrefix}_lbl_${idx}" value="${item.label}" class="border p-1">
                        <input type="number" id="${idPrefix}_val_${idx}" value="${item.val}" class="border p-1 text-center">
                        <button onclick="config.${target.replace('cfg-','')}.splice(${idx},1); renderAdmin();" class="text-red-500">x</button>
                    </div>`).join('');
            };
            
            ren(config.labour, 'adm_l', 'cfg-labour');
            ren(config.vehicles, 'adm_v', 'cfg-vehicles');
            ren(config.tasks, 'adm_t', 'cfg-tasks');
            ren(config.expenses, 'adm_e', 'cfg-expenses');
        }

        function addConfigRow(type) {
            config[type].push({ id: Math.random().toString(36).substr(2,5), label: "New Item", val: 0, type: type === 'tasks' ? 'hrs' : 'fixed' });
            renderAdmin();
        }

        async function saveConfig() {
            config.logo = document.getElementById('cfg-logo').value;
            config.terms = document.getElementById('cfg-terms').value;
            
            config.globals.forEach(g => g.val = parseFloat(document.getElementById(`adm_g_${g.id}`).value));
            
            const read = (arr, prefix) => arr.forEach((item, idx) => {
                item.label = document.getElementById(`${prefix}_lbl_${idx}`).value;
                item.val = parseFloat(document.getElementById(`${prefix}_val_${idx}`).value);
            });
            
            read(config.labour, 'adm_l');
            read(config.vehicles, 'adm_v');
            read(config.tasks, 'adm_t');
            read(config.expenses, 'adm_e');
            
            await supabase.from('app_settings').upsert({ id: 1, config: config });
            renderMainSheet();
            calc();
            toggleAdmin();
            showToast("Config Saved");
        }

        function showToast(m){ const x=document.getElementById("toast");x.innerText=m;x.className="show";setTimeout(()=>x.className=x.className.replace("show",""),3000); }
        function newEstimate() { if(confirm("Clear?")) location.reload(); }
    </script>
</body>
</html>
